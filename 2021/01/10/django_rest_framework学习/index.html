<!DOCTYPE html> <html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> <title>Web｜django_rest_framework学习 &mdash; Slience_me的博客</title> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/vendor/primer-css/css/primer.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/components/collection.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/components/repo-card.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/sections/repo-list.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/components/boxed-group.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/globals/common.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/globals/responsive.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/css/posts/index.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/vendor/octicons/octicons/octicons.css"> <link rel="stylesheet" href=" https://cdn.jsdelivr.net/npm/@docsearch/css@3 "/> <link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"> <link rel="stylesheet" href="https://blog.slienceme.cn/assets/vendor/share.js/dist/css/share.min.css"> <link rel="canonical" href="https://blog.slienceme.cn/2021/01/10/django_rest_framework%E5%AD%A6%E4%B9%A0/"> <link rel="alternate" type="application/atom+xml" title="Slience_me的博客" href="https://blog.slienceme.cn/feed.xml"> <link rel="shortcut icon" href="https://blog.slienceme.cn/favicon.ico"> <meta property="og:title" content="Web｜django_rest_framework学习"> <meta name="keywords" content="Python, 服务器, Web"> <meta name="og:keywords" content="Python, 服务器, Web"> <meta name="description" content=""> <meta name="og:description" content=""> <meta property="og:url" content="https://blog.slienceme.cn/2021/01/10/django_rest_framework%E5%AD%A6%E4%B9%A0/"> <meta property="og:site_name" content="Slience_me的博客"> <meta property="og:type" content="article"> <meta property="og:locale" content="zh_CN" /> <meta property="article:published_time" content="2021-01-10"> <meta name="google-site-verification" content="2feHjT1GNs1Yi2JQfOtdYx7d048naG_-cMwZaDAopIA" /> <script src="https://blog.slienceme.cn/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://blog.slienceme.cn/assets/js/main.js"></script> </head> <body class="" data-mz=""> <header class="site-header"> <div class="container"> <h1><a href="https://blog.slienceme.cn/" title="Slience_me的博客"><span class="octicon octicon-mark-github"></span> Slience_me的博客</a></h1> <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <nav class="site-header-nav" role="navigation"> <a href="https://blog.slienceme.cn/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://blog.slienceme.cn/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://blog.slienceme.cn/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://blog.slienceme.cn/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="https://blog.slienceme.cn/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="https://blog.slienceme.cn/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="https://blog.slienceme.cn/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://blog.slienceme.cn/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://blog.slienceme.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a> </nav> </div> </header> <section class="collection-head small geopattern" data-pattern-id="Web｜django_rest"> <div class="container"> <div class="columns"> <div class="column three-fourths"> <div class="collection-title"> <h1 class="collection-header">Web｜django_rest_framework学习</h1> <div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/01/10 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://blog.slienceme.cn/categories/#Python" title="Python">Python</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://blog.slienceme.cn/categories/#Web" title="Web">Web</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 49263 字，约 141 分钟 </span> </div> </div> </div> <div class="column one-fourth mobile-hidden"> <div class="collection-title"> </div> </div> </div> </div> </section> <section class="container content"> <div class="columns"> <div class="column three-fourths" > <article class="article-content markdown-body"> <p><img src="https://blog.slienceme.cn/images/posts/logo_slienceme3.png" alt="img" /></p> <p>本文作者： <a href="https://slienceme.cn/">slience_me</a></p> <hr /> <h1 id="django_rest_framework学习">django_rest_framework学习</h1> <h1 id="1-引入djangorestframework">1. 引入DjangoRESTframework</h1> <h2 id="11-web应用模式">1.1 Web应用模式</h2> <h3 id="前后端不分离">前后端不分离</h3> <p><img src="https://blog.slienceme.cn/images/posts/20210110213438585.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210110213538123.png" alt="Alt Text" /></p> <h3 id="前后端分离">前后端分离</h3> <p><img src="https://blog.slienceme.cn/images/posts/20210110212957596.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210110213243266.png" alt="Alt Text" /></p> <h2 id="12-认识restful">1.2 认识RESTful</h2> <p><strong>在前后端分离的应用模式里，API接口如何定义？</strong></p> <blockquote> <p>对于接口的请求方式与路径，每个后端开发人员可能都有自己的定义方式，风格迥异。</p> </blockquote> <blockquote> <p>是否存在一种统一的定义方式，被广大开发人员接受认可的方式呢？</p> </blockquote> <blockquote> <p>这就是被普遍采用的API的RESTful设计风格。</p> </blockquote> <blockquote> <p>例如对于后端数据库中保存了商品的信息，前端可能需要对商品数据进行增删改查，那相应的每个操作后端都需要提供一个API接口：</p> </blockquote> <p><img src="https://blog.slienceme.cn/images/posts/20210110214140336.png" alt="Alt Text" /></p> <h2 id="13-restful设计方法">1.3 RESTful设计方法</h2> <h3 id="1-域名">1. 域名</h3> <p>应该尽量将API部署在专用域名之下。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	https://api.example.com 如果确定API很简单，不会有进一步扩展，可以考虑放在主域名下。

https://example.org/api/ ### 2. 版本（Versioning） 应该将API的版本号放入URL。

http://www.example.com/app/1.0/foo

http://www.example.com/app/1.1/foo

http://www.example.com/app/2.0/foo
</code></pre></div></div> <p>另一种做法是，将版本号放在HTTP头信息中，但不如放入URL方便和直观。Github采用这种做法。</p> <p>因为不同的版本，可以理解成同一种资源的不同表现形式，所以应该采用同一个URL。版本号可以在HTTP请求头信息的Accept字段中进行区分（参见Versioning REST Services）：</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Accept: vnd.example-com.foo+json; version=1.0

Accept: vnd.example-com.foo+json; version=1.1

Accept: vnd.example-com.foo+json; version=2.0
</code></pre></div></div> <h3 id="3-路径endpoint">3. 路径（Endpoint）</h3> <p>路径又称”终点”（endpoint），表示API的具体网址，每个网址代表一种资源（resource）</p> <p><strong>(1) 资源作为网址，只能有名词，不能有动词，而且所用的名词往往与数据库的表名对应。</strong></p> <p>举例来说，以下是不好的例子:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/getProducts
/listOrders
/retreiveClientByOrder?orderId=1 对于一个简洁结构，你应该始终用名词。 此外，利用的HTTP方法可以分离网址中的资源名称的操作。

GET /products ：将返回所有产品清单
POST /products ：将产品新建到集合
GET /products/4 ：将获取产品 4
PATCH（或）PUT /products/4 ：将更新产品 4 **(2) API中的名词应该使用复数。无论子资源或者所有资源。**
</code></pre></div></div> <p>举例来说，获取产品的API可以这样定义</p> <blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>获取单个产品：http://127.0.0.1:8080/AppName/rest/products/1 	获取所有产品: http://127.0.0.1:8080/AppName/rest/products
</code></pre></div> </div> </blockquote> <h3 id="4-http动词">4. HTTP动词</h3> <p>对于资源的具体操作类型，由HTTP动词表示。</p> <p>常用的HTTP动词有下面四个（括号里是对应的SQL命令）。</p> <blockquote> <p>GET（SELECT）：从服务器取出资源（一项或多项）。 POST（CREATE）：在服务器新建一个资源。 PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。 DELETE（DELETE）：从服务器删除资源。</p> </blockquote> <p>还有三个不常用的HTTP动词。</p> <blockquote> <p>PATCH（UPDATE）：在服务器更新(更新)资源（客户端提供改变的属性）。 HEAD：获取资源的元数据。 OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。 下面是一些例子。</p> <p>GET /zoos：列出所有动物园 POST /zoos：新建一个动物园（上传文件） GET /zoos/ID：获取某个指定动物园的信息 PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息） PATCH/zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息） DELETE /zoos/ID：删除某个动物园 GET/zoos/ID/animals：列出某个指定动物园的所有动物 DELETE/zoos/ID/animals/ID：删除某个指定动物园的指定动物</p> </blockquote> <h3 id="5-过滤信息filtering">5. 过滤信息（Filtering）</h3> <p>如果记录数量很多，服务器不可能都将它们返回给用户。API应该提供参数，过滤返回结果。</p> <p>下面是一些常见的参数。</p> <blockquote> <p>?limit=10：指定返回记录的数量 ?offset=10：指定返回记录的开始位置。 ?page=2&amp;per_page=100：指定第几页，以及每页的记录数。 ?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序。 ?animal_type_id=1：指定筛选条件</p> </blockquote> <p>参数的设计允许存在冗余，即允许API路径和URL参数偶尔有重复。比如，GET /zoos/ID/animals 与 GET /animals?zoo_id=ID 的含义是相同的。</p> <h3 id="6-状态码status-codes">6. 状态码（Status Codes）</h3> <p>服务器向用户返回的状态码和提示信息，常见的有以下一些（方括号中是该状态码对应的HTTP动词）。</p> <blockquote> <p>200 OK - [GET]：服务器成功返回用户请求的数据 201 CREATED -[POST/PUT/PATCH]：用户新建或修改数据成功 202 Accepted - [<em>]：表示一个请求已经进入后台排队（异步任务） 204 NO CONTENT - [DELETE]：用户删除数据成功。 400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作 401 Unauthorized - [</em>]：表示用户没有权限（令牌、用户名、密码错误）。 403 Forbidden - [<em>]表示用户得到授权（与401错误相对），但是访问是被禁止的。 404 NOT FOUND - [</em>]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。 406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。 410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。 422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。 500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。 状态码的完全列表参见这里或这里。</p> </blockquote> <h3 id="7-错误处理error-handling">7. 错误处理（Error handling）</h3> <p>如果状态码是4xx，服务器就应该向用户返回出错信息。一般来说，返回的信息中将error作为键名，出错信息作为键值即可。</p> <blockquote> <p>{ error: “Invalid API key” }</p> </blockquote> <h3 id="8-返回结果">8. 返回结果</h3> <p>针对不同操作，服务器向用户返回的结果应该符合以下规范。</p> <blockquote> <p>GET /collection：返回资源对象的列表（数组） GET /collection/resource：返回单个资源对象 POST /collection：返回新生成的资源对象 PUT /collection/resource：返回完整的资源对象 PATCH /collection/resource：返回完整的资源对象 DELETE /collection/resource：返回一个空文档</p> </blockquote> <p><img src="https://blog.slienceme.cn/images/posts/20210110215759627.png" alt="Alt Text" /></p> <h3 id="10-其他">10. 其他</h3> <p>服务器返回的数据格式，应该尽量使用JSON，避免使用XML。</p> <h2 id="14-使用django开发rest-接口">1.4 使用Django开发REST 接口</h2> <p>我们以在Django框架中使用的图书英雄案例来写一套支持图书数据增删改查的REST API接口，来理解REST API的开发。</p> <p>在此案例中，前后端均发送JSON格式数据。</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># views.py
</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">BooksAPIVIew</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="s">"""
    查询所有图书、增加图书
    """</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        查询所有图书
        路由：GET /books/
        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="n">book_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">book_list</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
                <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
                <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
                <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
                <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">book_list</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        新增图书
        路由：POST /books/ 
        """</span>
        <span class="n">json_bytes</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">book_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>

        <span class="c1"># 此处详细的校验参数省略
</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">btitle</span><span class="o">=</span><span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'btitle'</span><span class="p">),</span>
            <span class="n">bpub_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bpub_date'</span><span class="p">),</span> <span class="s">'%Y-%m-%d'</span><span class="p">).</span><span class="n">date</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BookAPIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""
        获取单个图书信息
        路由： GET  /books/&lt;pk&gt;/
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""
        修改图书信息
        路由： PUT  /books/&lt;pk&gt;
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">json_bytes</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">book_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>

        <span class="c1"># 此处详细的校验参数省略
</span>
        <span class="n">book</span><span class="p">.</span><span class="n">btitle</span> <span class="o">=</span> <span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'btitle'</span><span class="p">)</span>
        <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bpub_date'</span><span class="p">),</span> <span class="s">'%Y-%m-%d'</span><span class="p">).</span><span class="n">date</span><span class="p">()</span>
        <span class="n">book</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""
        删除图书
        路由： DELETE /books/&lt;pk&gt;/
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">book</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># urls.py
</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BooksAPIVIew</span><span class="p">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookAPIView</span><span class="p">.</span><span class="n">as_view</span><span class="p">())</span>
<span class="p">]</span>
</code></pre></div></div> <p><strong>测试</strong> 使用Postman测试上述接口</p> <blockquote> <p>1） 获取所有图书数据</p> <p>GET 方式访问 http://127.0.0.1:8000/books/， 返回状态码200，数据如下</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"射雕英雄传"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1980-05-01"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"天龙八部"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1986-07-24"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"笑傲江湖"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1995-12-24"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"雪山飞狐"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1987-11-11"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"西游记"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1988-01-01"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">"booktest/xiyouji.png"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"水浒传"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1992-01-01"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">"id"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"红楼梦"</span><span class="p">,</span>
        <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1990-01-01"</span><span class="p">,</span>
        <span class="s">"bread"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div> <blockquote> <p>2）获取单一图书数据</p> <p>GET 访问 http://127.0.0.1:8000/books/5/ ，返回状态码200， 数据如下</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"西游记"</span><span class="p">,</span>
    <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1988-01-01"</span><span class="p">,</span>
    <span class="s">"bread"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s">"image"</span><span class="p">:</span> <span class="s">"booktest/xiyouji.png"</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>GET 访问http://127.0.0.1:8000/books/100/，返回状态码404</p> <p>3）新增图书数据</p> <p>POST 访问http://127.0.0.1:8000/books/，发送JSON数据：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"三国演义"</span><span class="p">,</span>
    <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1990-02-03"</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>返回状态码201，数据如下</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"三国演义"</span><span class="p">,</span>
    <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1990-02-03"</span><span class="p">,</span>
    <span class="s">"bread"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>4）修改图书数据 PUT 访问http://127.0.0.1:8000/books/8/，发送JSON数据：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"三国演义（第二版）"</span><span class="p">,</span>
    <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1990-02-03"</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>返回状态码200，数据如下</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s">"btitle"</span><span class="p">:</span> <span class="s">"三国演义（第二版）"</span><span class="p">,</span>
    <span class="s">"bpub_date"</span><span class="p">:</span> <span class="s">"1990-02-03"</span><span class="p">,</span>
    <span class="s">"bread"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">"bcomment"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">"image"</span><span class="p">:</span> <span class="s">""</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>5）删除图书数据</p> <p>DELETE 访问http://127.0.0.1:8000/books/8/，返回204状态码</p> </blockquote> <p><strong>源码</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="s">"""
GET         /books/
POST        /books/
GET         /books/&lt;pk&gt;/
PUT         /books/&lt;pk&gt;/
DELETE      /books/&lt;pk&gt;/

响应数据  JSON
# 列表视图: 路由后边没有pk/ID
# 详情视图: 路由后面   pk/ID
"""</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">BookInfo</span>


<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""查询所有图书接口"""</span>
        <span class="c1"># 1. 查询出所有图书模型
</span>        <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="c1"># 2. 遍历查询集，去除里边的每个书籍模型对象，把模型对象转换成字典
</span>        <span class="c1"># 定义一个列表保存所有字典
</span>        <span class="n">book_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
            <span class="n">book_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
                <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
                <span class="s">'bput_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
                <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
                <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">book_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">book_dict</span><span class="p">)</span>  <span class="c1"># 将转换好的字典添加到列表中
</span>        <span class="c1"># 3. 响应给前端
</span>        <span class="c1"># 如果book_;list 不是一个字典的话就需要将safe设置成False.
</span>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">book_list</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""新增图书接口"""</span>
        <span class="c1"># 获取前端传入的请求体数据(json) request.body
</span>        <span class="n">json_str_bytes</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span>
        <span class="c1"># 把bytes类型的json字符串转换成json_str
</span>        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="c1"># 利用json.loads将json字符串扎UN干哈UN从json（字典/列表）
</span>        <span class="n">book_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="c1"># 创建模型对象并保存（把字典转换成模型并储存）
</span>        <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">(</span>
            <span class="n">btitle</span><span class="o">=</span><span class="n">book_dict</span><span class="p">[</span><span class="s">'btitle'</span><span class="p">],</span>
            <span class="n">bpub_date</span><span class="o">=</span><span class="n">book_dict</span><span class="p">[</span><span class="s">'bpub_date'</span><span class="p">],</span>

        <span class="p">)</span>
        <span class="n">book</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># 把新增的模型转换成字典
</span>        <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bput_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span><span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># 响应（把新增的数据再响应回去，201）
</span>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="s">"""详情视图"""</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""查询指定某个图书馆接口"""</span>
        <span class="c1"># 1. 获取出指定pk的那个模型对象
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'查询的数据不存在'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
        <span class="c1"># 2. 模型对象转字典
</span>        <span class="n">book_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bput_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span><span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># 3. 响应
</span>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">book_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""修改指定图书馆接口"""</span>
        <span class="c1"># 先查询要修改的模型对象
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'查询的数据不存在'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
        <span class="c1"># 获取前端传入的新数据（把数据转换成字典）
</span>        <span class="c1"># json_str_bytes = request.body
</span>        <span class="c1"># json_str = json_str_bytes.decode()
</span>        <span class="c1"># book_dict = json.loads(json_str)
</span>
        <span class="n">book_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="c1"># 重新给模型指定的属性赋值
</span>        <span class="n">book</span><span class="p">.</span><span class="n">btitle</span> <span class="o">=</span> <span class="n">book_dict</span><span class="p">[</span><span class="s">'btitle'</span><span class="p">]</span>
        <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span> <span class="o">=</span> <span class="n">book_dict</span><span class="p">[</span><span class="s">'bpub_date'</span><span class="p">]</span>

        <span class="c1"># 调用save方法进行修改操作
</span>        <span class="n">book</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># 把修改后的模型再转换成字典
</span>        <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
            <span class="s">'bput_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
            <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
            <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># 响应
</span>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""删除指定图书接口"""</span>
        <span class="c1"># 获取要删除的模型对象
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span><span class="s">'查询的数据不存在'</span><span class="p">},</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
        <span class="c1"># 删除指定模型对象
</span>        <span class="n">book</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># 物理删除（真正从数据库删除）
</span>        <span class="c1"># book.is_delete = True
</span>        <span class="c1"># book.save()  # （逻辑删除）
</span>        <span class="c1"># 响应：删除时不需要有响应体但要指定状态码为 204
</span>        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>


</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="c1"># Create your models here.
# 定义图书模型类BookInfo
</span><span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'名称'</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">)</span>
    <span class="n">is_delete</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'逻辑删除'</span><span class="p">)</span>
    <span class="c1"># 注意,如果模型已经迁移建表并且表中如果已经有数据了,那么后新增的字段,必须给默认值或可以为空,不然迁移就报错
</span>    <span class="c1"># upload_to 指定上传到media_root配置项的目录中再创建booktest里面
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">'booktest'</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s">'tb_books'</span>  <span class="c1"># 指明数据库表名
</span>        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">'图书'</span>  <span class="c1"># 在admin站点中显示的名称
</span>        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">verbose_name</span>  <span class="c1"># 显示的复数名称
</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""定义每个数据对象的显示信息"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">btitle</span>

    <span class="k">def</span> <span class="nf">pub_date_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">)</span>
    <span class="c1"># 修改方法名在列表界面的展示
</span>    <span class="n">pub_date_format</span><span class="p">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s">'发布日期'</span>
    <span class="c1"># 指定自定义方法的排序依据
</span>    <span class="n">pub_date_format</span><span class="p">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s">'bpub_date'</span>


<span class="c1"># 定义英雄模型类HeroInfo
</span><span class="k">class</span> <span class="nc">HeroInfo</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">GENDER_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'female'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'male'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">hname</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'名称'</span><span class="p">)</span>
    <span class="n">hgender</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">GENDER_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'性别'</span><span class="p">)</span>
    <span class="n">hcomment</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'描述信息'</span><span class="p">)</span>
    <span class="n">hbook</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">BookInfo</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'图书'</span><span class="p">)</span>  <span class="c1"># 外键
</span>    <span class="n">is_delete</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'逻辑删除'</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s">'tb_heros'</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">'英雄'</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">verbose_name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">hname</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">hbook</span><span class="p">.</span><span class="n">bread</span>
    <span class="n">read</span><span class="p">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s">'阅读量'</span>
    <span class="n">read</span><span class="p">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s">'hbook__bread'</span>
    <span class="c1"># HeroInfo.objects.filter(hbook__bread=xx)
</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># 列表视图的路由
</span>    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookListView</span><span class="p">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="c1"># 详情视图的路由
</span>    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookDetailView</span><span class="p">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 配置项目中静态文件存放/读取目录
</span><span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># http://127.0.0.1:8000/static/index.html
</span>    <span class="c1"># http://127.0.0.1:8000/static/mm03.jpg
</span>    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'static_files'</span><span class="p">),</span>
    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'static_files/good'</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># 指定上传文件存储目录
</span><span class="n">MEDIA_ROOT</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span><span class="s">"static_files/media"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="15-明确rest接口开发的核心任务">1.5 明确REST接口开发的核心任务</h2> <p>分析一下上节的案例，可以发现，在开发REST API接口时，视图中做的最主要有三件事：</p> <blockquote> <p>将请求的数据（如JSON格式）转换为模型类对象 操作数据库 将模型类对象转换为响应的数据（如JSON格式）</p> </blockquote> <h3 id="序列化serialization">序列化Serialization</h3> <blockquote> <p>维基百科中对于序列化的定义：</p> <p>序列化（serialization）在计算机科学的资料处理中，是指将数据结构或物件状态转换成可取用格式（例如存成档案，存于缓冲，或经由网络中传送），以留待后续在相同或另一台计算机环境中，能恢复原先状态的过程。依照序列化格式重新获取字节的结果时，可以利用它来产生与原始物件相同语义的副本。对于许多物件，像是使用大量参照的复杂物件，这种序列化重建的过程并不容易。面向对象中的物件序列化，并不概括之前原始物件所关联的函式。这种过程也称为物件编组（marshalling）。从一系列字节提取数据结构的反向操作，是反序列化（也称为解编组, deserialization, unmarshalling）。</p> <p>序列化在计算机科学中通常有以下定义:</p> <p>​ 在数据储存与传送的部分是指将一个对象)存储至一个储存媒介，例如档案或是记亿体缓冲等，或者透过网络传送资料时进行编码的过程，可以是字节或是XML等格式。而字节的或XML编码格式可以还原完全相等的对象)。这程序被应用在不同应用程序之间传送对象)，以及服务器将对象)储存到档案或数据库。相反的过程又称为反序列化。</p> <p>简而言之，我们可以将序列化理解为：</p> <p>将程序中的一个数据结构类型转换为其他格式（字典、JSON、XML等），例如将Django中的模型类对象装换为JSON字符串，这个转换过程我们称为序列化。</p> </blockquote> <p><strong>如：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
<span class="n">book_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 序列化
</span><span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
    <span class="n">book_list</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
        <span class="s">'btitle'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">btitle</span><span class="p">,</span>
        <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">,</span>
        <span class="s">'bread'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bread</span><span class="p">,</span>
        <span class="s">'bcomment'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bcomment</span><span class="p">,</span>
        <span class="s">'image'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">book</span><span class="p">.</span><span class="n">image</span> <span class="k">else</span> <span class="s">''</span>
    <span class="p">})</span>
<span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">book_list</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>反之，将其他格式（字典、JSON、XML等）转换为程序中的数据，例如将JSON字符串转换为Django中的模型类对象，这个过程我们称为反序列化。</p> </blockquote> <p><strong>如：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">json_bytes</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span>
<span class="n">json_str</span> <span class="o">=</span> <span class="n">json_bytes</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>

<span class="c1"># 反序列化
</span><span class="n">book_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">btitle</span><span class="o">=</span><span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'btitle'</span><span class="p">),</span>
    <span class="n">bpub_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">book_dict</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bpub_date'</span><span class="p">),</span> <span class="s">'%Y-%m-%d'</span><span class="p">).</span><span class="n">date</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div></div> <blockquote> <p>我们可以看到，在开发REST API时，视图中要频繁的进行序列化与反序列化的编写。</p> <p>总结 在开发REST API接口时，我们在视图中需要做的最核心的事是：</p> <ul> <li>将数据库数据序列化为前端所需要的格式，并返回；</li> <li>将前端发送的数据反序列化为模型类对象，并保存到数据库中。</li> </ul> </blockquote> <h2 id="16-django-rest-framework-简介">1.6 Django REST framework 简介</h2> <blockquote> <ol> <li>在序列化与反序列化时，虽然操作的数据不尽相同，但是执行的过程却是相似的，也就是说这部分代码是可以复用简化编写的。</li> <li>在开发RESTAPI的视图中，虽然每个视图具体操作的数据不同，但增、删、改、查的实现流程基本套路化，所以这部分代码也是可以复用简化编写的： <ul> <li>增：校验请求数据 -&gt; 执行反序列化过程 -&gt; 保存数据库 -&gt; 将保存的对象序列化并返回</li> <li>删：判断要删除的数据是否存在 -&gt;执行数据库删除</li> <li>改：判断要修改的数据是否存在 -&gt; 校验请求的数据 -&gt; 执行反序列化过程 -&gt; 保存数据库 -&gt; 将保存的对象序列化并返回</li> <li>查：查询数据库 -&gt; 将数据序列化并返回</li> </ul> </li> </ol> </blockquote> <blockquote> <p>Django REST framework可以帮助我们简化上述两部分的代码编写，大大提高REST API的开发速度。</p> </blockquote> <h3 id="认识django-rest-framework">认识Django REST framework</h3> <p><img src="https://blog.slienceme.cn/images/posts/20210111123030136.png" alt="Alt Text" /></p> <blockquote> <p>Django REST framework 框架是一个用于构建Web API 的强大而又灵活的工具。</p> <p>通常简称为DRF框架 或 REST framework。</p> <p>DRF框架是建立在Django框架基础之上，由Tom Christie大牛二次开发的开源项目。</p> </blockquote> <p>特点</p> <blockquote> <ul> <li>提供了定义序列化器Serializer的方法，可以快速根据 Django ORM 或者其它库自动序列化/反序列化；</li> <li>提供了丰富的类视图、Mixin扩展类，简化视图的编写；</li> <li>丰富的定制层级：函数视图、类视图、视图集合到自动生成 API， 满足各种需要；</li> <li>多种身份认证和权限认证方式的支持；</li> <li>内置了限流系统；</li> <li>直观的 API web 界面；</li> <li>可扩展性，插件丰富</li> </ul> </blockquote> <h1 id="2-drf工程搭建">2. DRF工程搭建</h1> <h2 id="环境安装与配置">环境安装与配置</h2> <blockquote> <p>DRF需要以下依赖：</p> </blockquote> <ul> <li>Python (2.7, 3.4, 3.5, 3.6, 3.7)</li> <li>Django (1.11, 2.0, 2.1)</li> </ul> <blockquote> <p>DRF是以Django扩展应用的方式提供的，所以我们可以直接利用已有的Django环境而无需从新创建。（若没有Django环境，需要先创建环境安装Django）</p> </blockquote> <blockquote> <ol> <li>安装DRF</li> </ol> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip</span> <span class="n">install</span> <span class="n">djangorestframework</span>
</code></pre></div></div> <blockquote> <ol> <li>添加rest_framework应用</li> </ol> </blockquote> <blockquote> <p>我们利用在Django框架学习中创建的demo工程，在settings.py的INSTALLED_APPS中添加’rest_framework’。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="s">'rest_framework'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div> <blockquote> <p>接下来就可以使用DRF进行开发了。</p> </blockquote> <h2 id="见识drf的魅力">见识DRF的魅力</h2> <blockquote> <p>我们仍以在学习Django框架时使用的图书英雄为案例，使用Django REST framework快速实现图书的REST API。</p> <h3 id="1-创建序列化器">1. 创建序列化器</h3> <p>在booktest应用中新建serializers.py用于保存该应用的序列化器。 创建一个BookInfoSerializer用于序列化与反序列化。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
</code></pre></div></div> <ul> <li>model 指明该序列化器处理的数据字段从模型类BookInfo参考生成</li> <li>fields 指明该序列化器包含模型类中的哪些字段，’<strong>all</strong>‘指明包含所有字段</li> </ul> <h3 id="2-编写视图">2. 编写视图</h3> <blockquote> <p>在booktest应用的views.py中创建视图BookInfoViewSet，这是一个视图集合。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">BookInfo</span>

<span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
</code></pre></div></div> <ul> <li>queryset 指明该视图集在查询数据时使用的查询集</li> <li>serializer_class 指明该视图在进行序列化或反序列化时使用的序列化器</li> </ul> <h3 id="3-定义路由">3. 定义路由</h3> <blockquote> <p>在booktest应用的urls.py中定义路由信息。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>
<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">DefaultRouter</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
<span class="p">]</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">DefaultRouter</span><span class="p">()</span>  <span class="c1"># 可以处理视图的路由器
</span><span class="n">router</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s">'books'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">)</span>  <span class="c1"># 向路由器中注册视图集
</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">router</span><span class="p">.</span><span class="n">urls</span>  <span class="c1"># 将路由器中的所以路由信息追到到django的路由列表中
</span></code></pre></div></div> <h3 id="4-运行测试">4. 运行测试</h3> <blockquote> <p>运行当前程序（与运行Django一样）</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">runserver</span>
</code></pre></div></div> <blockquote> <p>在浏览器中输入网址127.0.0.1:8000，可以看到DRF提供的API Web浏览页面： <img src="https://blog.slienceme.cn/images/posts/20210111125355866.png" alt="Alt Text" /> 1）点击链接127.0.0.1:8000/books/ 可以访问获取所有数据的接口，呈现如下页面： <img src="https://blog.slienceme.cn/images/posts/20210111125412844.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111125424351.png" alt="Alt Text" /> 2）在页面底下表单部分填写图书信息，可以访问添加新图书的接口，保存新书： <img src="https://blog.slienceme.cn/images/posts/20210111125438813.png" alt="Alt Text" /> 点击POST后，返回如下页面信息： <img src="https://blog.slienceme.cn/images/posts/20210111125451124.png" alt="Alt Text" /> 3）在浏览器中输入网址127.0.0.1:8000/books/1/，可以访问获取单一图书信息的接口（id为1的图书），呈现如下页面： <img src="https://blog.slienceme.cn/images/posts/20210111125501489.png" alt="Alt Text" /> 4）在页面底部表单中填写图书信息，可以访问修改图书的接口： <img src="https://blog.slienceme.cn/images/posts/20210111125511348.png" alt="Alt Text" /> 点击PUT，返回如下页面信息： <img src="https://blog.slienceme.cn/images/posts/20210111125520818.png" alt="Alt Text" /> 5）点击DELETE按钮，可以访问删除图书的接口： <img src="https://blog.slienceme.cn/images/posts/20210111125530533.png" alt="Alt Text" /> 返回，如下页面： <img src="https://blog.slienceme.cn/images/posts/20210111125541653.png" alt="Alt Text" /> 至此，是不是发现Django REST framework很好用！</p> </blockquote> <h1 id="3-serializer序列化器">3. Serializer序列化器</h1> <h2 id="序列化器的作用">序列化器的作用：</h2> <ol> <li>进行数据的校验</li> <li>对数据对象进行转换</li> </ol> <h2 id="31-定义serializer">3.1 定义Serializer</h2> <h3 id="1-定义方法">1. 定义方法</h3> <blockquote> <p>Django REST framework中的Serializer使用类来定义，须继承自rest_framework.serializers.Serializer。</p> <p>例如，我们已有了一个数据库模型类BookInfo</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'名称'</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">'booktest'</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>我们想为这个模型类提供一个序列化器，可以定义如下：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名称'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>注意：serializer不是只能为数据库模型类定义，也可以为非数据库模型类的数据定义。serializer是独立于数据库之外的存在。</p> <h3 id="2-字段与选项">2. 字段与选项</h3> <p>常用字段类型： <img src="https://blog.slienceme.cn/images/posts/2021011113015420.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111130210207.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111130231783.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111130240825.png" alt="Alt Text" /></p> <h3 id="3-创建serializer对象">3. 创建Serializer对象</h3> <p>定义好Serializer类后，就可以创建Serializer对象了。</p> </blockquote> <p>Serializer的构造方法为：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Serializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">empty</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>说明：</p> <p>1）用于序列化时，将模型类对象传入instance参数</p> <p>2）用于反序列化时，将要被反序列化的数据传入data参数</p> <p>3）除了instance和data参数外，在构造Serializer对象时，还可通过context参数额外添加数据，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serializer</span> <span class="o">=</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s">'request'</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
</code></pre></div></div> <blockquote> <p>通过context参数附加的数据，可以通过Serializer对象的context属性获取。</p> </blockquote> <h2 id="32-序列化使用">3.2 序列化使用</h2> <blockquote> <p>我们在django shell中来学习序列化器的使用。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">shell</span>
</code></pre></div></div> <h3 id="1-基本使用">1 基本使用</h3> <blockquote> <p>1） 先查询出一个图书对象</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.models</span> <span class="kn">import</span> <span class="n">BookInfo</span>

<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>2） 构造序列化器对象</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>

<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>3）获取序列化数据 通过data属性可以获取序列化后的数据</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serializer</span><span class="p">.</span><span class="n">data</span>
<span class="c1"># {'id': 2, 'btitle': '天龙八部', 'bpub_date': '1986-07-24', 'bread': 36, 'bcomment': 40, 'image': None}
</span></code></pre></div></div> <blockquote> <p>4）如果要被序列化的是包含多条数据的查询集QuerySet，可以通过添加many=True参数补充说明</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">book_qs</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">book_qs</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">data</span>
<span class="c1"># [OrderedDict([('id', 2), ('btitle', '天龙八部'), ('bpub_date', '1986-07-24'), ('bread', 36), ('bcomment', 40), ('image', N]), OrderedDict([('id', 3), ('btitle', '笑傲江湖'), ('bpub_date', '1995-12-24'), ('bread', 20), ('bcomment', 80), ('image'ne)]), OrderedDict([('id', 4), ('btitle', '雪山飞狐'), ('bpub_date', '1987-11-11'), ('bread', 58), ('bcomment', 24), ('ima None)]), OrderedDict([('id', 5), ('btitle', '西游记'), ('bpub_date', '1988-01-01'), ('bread', 10), ('bcomment', 10), ('im', 'booktest/xiyouji.png')])]
</span></code></pre></div></div> <h3 id="2-关联对象嵌套序列化">2 关联对象嵌套序列化</h3> <blockquote> <p>如果需要序列化的数据中包含有其他关联对象，则对关联对象数据的序列化需要指明。</p> <p>例如，在定义英雄数据的序列化器时，外键hbook（即所属的图书）字段如何序列化？</p> <p>我们先定义HeroInfoSerialzier除外键字段外的其他部分</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HeroInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""英雄数据序列化器"""</span>
    <span class="n">GENDER_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'female'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'male'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">hname</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名字'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">hgender</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">GENDER_CHOICES</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'性别'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">hcomment</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'描述信息'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>对于关联字段，可以采用以下几种方式：</p> <h4 id="1-primarykeyrelatedfield">1 PrimaryKeyRelatedField</h4> <p>此字段将被序列化为关联对象的主键。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hbook</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图书'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">或</span>
<span class="n">hbook</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图书'</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">())</span>
</code></pre></div></div> <p>指明字段时需要包含read_only=True或者queryset参数：</p> <ul> <li>包含read_only=True参数时，该字段将不能用作反序列化使用</li> <li>包含queryset参数时，将被用作反序列化时参数校验使用</li> </ul> <p>使用效果：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">HeroInfoSerializer</span>
<span class="kn">from</span> <span class="nn">booktest.models</span> <span class="kn">import</span> <span class="n">HeroInfo</span>
<span class="n">hero</span> <span class="o">=</span> <span class="n">HeroInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">HeroInfoSerializer</span><span class="p">(</span><span class="n">hero</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">data</span>
<span class="c1"># {'id': 6, 'hname': '乔峰', 'hgender': 1, 'hcomment': '降龙十八掌', 'hbook': 2}
</span></code></pre></div></div> <h4 id="2--stringrelatedfield">2 StringRelatedField</h4> <p>此字段将被序列化为关联对象的字符串表示方式（即__str__方法的返回值）</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hbook</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">StringRelatedField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图书'</span><span class="p">)</span>
</code></pre></div></div> <p>使用效果</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">'hname'</span><span class="p">:</span> <span class="s">'乔峰'</span><span class="p">,</span> <span class="s">'hgender'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'hcomment'</span><span class="p">:</span> <span class="s">'降龙十八掌'</span><span class="p">,</span> <span class="s">'hbook'</span><span class="p">:</span> <span class="s">'天龙八部'</span><span class="p">}</span>
</code></pre></div></div> <h4 id="3-使用关联对象的序列化器">3 使用关联对象的序列化器</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hbook</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">()</span>
</code></pre></div></div> <p>使用效果</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">'hname'</span><span class="p">:</span> <span class="s">'乔峰'</span><span class="p">,</span> <span class="s">'hgender'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'hcomment'</span><span class="p">:</span> <span class="s">'降龙十八掌'</span><span class="p">,</span> <span class="s">'hbook'</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s">'id'</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">'btitle'</span><span class="p">,</span> <span class="s">'天龙八部'</span><span class="p">)</span><span class="n">te</span><span class="s">', '</span><span class="mi">1986</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span><span class="s">'), ('</span><span class="n">bread</span><span class="s">', 36), ('</span><span class="n">bcomment</span><span class="s">', 40), ('</span><span class="n">image</span><span class="s">', None)])}
</span></code></pre></div></div> <h3 id="3-many参数">3 many参数</h3> <blockquote> <p>如果关联的对象数据不是只有一个，而是包含多个数据，如想序列化图书BookInfo数据，每个BookInfo对象关联的英雄HeroInfo对象可能有多个，此时关联字段类型的指明仍可使用上述几种方式，只是在声明关联字段时，多补充一个many=True参数即可。</p> <p>此处仅拿PrimaryKeyRelatedField类型来举例，其他相同。</p> <p>在BookInfoSerializer中添加关联字段：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名称'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">heroinfo_set</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># 新增
</span></code></pre></div></div> <p>使用效果：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="kn">from</span> <span class="nn">booktest.models</span> <span class="kn">import</span> <span class="n">BookInfo</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">data</span>
<span class="c1"># {'id': 2, 'btitle': '天龙八部', 'bpub_date': '1986-07-24', 'bread': 36, 'bcomment': 40, 'image': None, 'heroinfo_set': [6,8, 9]}
</span></code></pre></div></div> <p><img src="https://blog.slienceme.cn/images/posts/20210111181216798.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111203958439.png" alt="Alt Text" /></p> <h2 id="33-反序列化使用">3.3 反序列化使用</h2> <h3 id="1-验证">1. 验证</h3> <blockquote> <p>使用序列化器进行反序列化时，需要对数据进行验证后，才能获取验证成功的数据或保存成模型类对象。</p> </blockquote> <blockquote> <p>在获取反序列化的数据前，必须调用is_valid()方法进行验证，验证成功返回True，否则返回False。</p> </blockquote> <blockquote> <p>验证失败，可以通过序列化器对象的errors属性获取错误信息，返回字典，包含了字段和字段的错误。如果是非字段错误，可以通过修改REST framework配置中的NON_FIELD_ERRORS_KEY来控制错误字典中的键名。</p> </blockquote> <blockquote> <p>验证成功，可以通过序列化器对象的validated_data属性获取数据。</p> </blockquote> <blockquote> <p>在定义序列化器时，指明每个字段的序列化类型和选项参数，本身就是一种验证行为。</p> </blockquote> <blockquote> <p>如我们前面定义过的BookInfoSerializer</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名称'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>通过构造序列化器对象，并将要反序列化的数据传递给data构造参数，进而进行验证</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'bpub_date'</span><span class="p">:</span> <span class="mi">123</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># 返回False
</span><span class="n">serializer</span><span class="p">.</span><span class="n">errors</span>
<span class="c1"># {'btitle': [ErrorDetail(string='This field is required.', code='required')], 'bpub_date': [ErrorDetail(string='Date has wrong format. Use one of these formats instead: YYYY[-MM[-DD]].', code='invalid')]}
</span><span class="n">serializer</span><span class="p">.</span><span class="n">validated_data</span>  <span class="c1"># {}
</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'python'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">:</span> <span class="s">'1998-12-1'</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># True
</span><span class="n">serializer</span><span class="p">.</span><span class="n">errors</span>  <span class="c1"># {}
</span><span class="n">serializer</span><span class="p">.</span><span class="n">validated_data</span>  <span class="c1">#  OrderedDict([('btitle', 'python')])
</span></code></pre></div></div> <blockquote> <p>is_valid()方法还可以在验证失败时抛出异常serializers.ValidationError，可以通过传递raise_exception=True参数开启，REST framework接收到此异常，会向前端返回HTTP 400 Bad Request响应。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Return a 400 response if the data was invalid.
</span><span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>如果觉得这些还不够，需要再补充定义验证行为，可以使用以下三种方法：</p> <h4 id="1validate_">1）validate_<field_name></field_name></h4> <p>对<field_name>字段进行验证，如</field_name></p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">validate_btitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">'django'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"图书不是关于Django的"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div> <blockquote> <p>测试</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'python'</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># False   
</span><span class="n">serializer</span><span class="p">.</span><span class="n">errors</span>
<span class="c1">#  {'btitle': [ErrorDetail(string='图书不是关于Django的', code='invalid')]}
</span></code></pre></div></div> <h4 id="2validate">2）validate</h4> <blockquote> <p>在序列化器中需要同时对多个字段进行比较验证时，可以定义validate方法来验证，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">bread</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">'bread'</span><span class="p">]</span>
        <span class="n">bcomment</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">'bcomment'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bread</span> <span class="o">&lt;</span> <span class="n">bcomment</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">'阅读量小于评论量'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span>
</code></pre></div></div> <blockquote> <p>测试</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'about django'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">:</span> <span class="s">'1998-12-1'</span><span class="p">,</span> <span class="s">'bread'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s">'bcomment'</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># False
</span><span class="n">s</span><span class="p">.</span><span class="n">errors</span>
<span class="c1">#  {'non_field_errors': [ErrorDetail(string='阅读量小于评论量', code='invalid')]}
</span></code></pre></div></div> <h4 id="3validators">3）validators</h4> <blockquote> <p>在字段中添加validators选项参数，也可以补充验证行为，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">about_django</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'django'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"图书不是关于Django的"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名称'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">about_django</span><span class="p">])</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>测试：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'python'</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># False   
</span><span class="n">serializer</span><span class="p">.</span><span class="n">errors</span>
<span class="c1">#  {'btitle': [ErrorDetail(string='图书不是关于Django的', code='invalid')]}
</span></code></pre></div></div> <h4 id="2-保存">2. 保存</h4> <blockquote> <p>如果在验证成功后，想要基于validated_data完成数据对象的创建，可以通过实现create()和update()两个方法来实现。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="s">"""新建"""</span>
        <span class="k">return</span> <span class="n">BookInfo</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="s">"""更新，instance为要更新的对象实例"""</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">btitle</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'btitle'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">btitle</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bpub_date</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bpub_date'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bread</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bread'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bread</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bcomment</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bcomment'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bcomment</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></div> <blockquote> <p>如果需要在返回数据对象的时候，也将数据保存到数据库中，则可以进行如下修改</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="s">"""新建"""</span>
        <span class="k">return</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="s">"""更新，instance为要更新的对象实例"""</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">btitle</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'btitle'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">btitle</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bpub_date</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bpub_date'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bread</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bread'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bread</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">bcomment</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bcomment'</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">bcomment</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></div> <blockquote> <p>实现了上述两个方法后，在反序列化数据的时候，就可以通过save()方法返回一个数据对象实例了</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">book</span> <span class="o">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div> <blockquote> <p>如果创建序列化器对象的时候，没有传递instance实例，则调用save()方法的时候，create()被调用，相反，如果传递了instance实例，则调用save()方法的时候，update()被调用。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">db.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'封神演义'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">:</span> <span class="s">'1998-1-1'</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># True
</span><span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># &lt;BookInfo: 封神演义&gt;
</span>
<span class="kn">from</span> <span class="nn">db.models</span> <span class="kn">import</span> <span class="n">BookInfo</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'倚天剑'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">:</span> <span class="s">'1998-12-18'</span><span class="p">}</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">book</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>  <span class="c1"># True
</span><span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># &lt;BookInfo: 倚天剑&gt;
</span><span class="n">book</span><span class="p">.</span><span class="n">btitle</span>  <span class="c1"># '倚天剑'
</span></code></pre></div></div> <h5 id="两点说明">两点说明：</h5> <blockquote> <p>1）在对序列化器进行save()保存时，可以额外传递数据，这些数据可以在create()和update()中的validated_data参数获取到</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>2）默认序列化器必须传递所有required为True的字段，否则会抛出验证异常。但是我们可以使用partial参数来允许部分字段在更新操作时可以不传,而使用原有的数据</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">book</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'hello django'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">:</span> <span class="n">book</span><span class="p">.</span><span class="n">bpub_date</span><span class="p">})</span>
<span class="c1"># 两种写法最终效果等价
</span><span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">book</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'btitle'</span><span class="p">:</span> <span class="s">'hello django'</span><span class="p">},</span> <span class="n">partial</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre></div></div> <p><img src="https://blog.slienceme.cn/images/posts/20210111201651905.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111201808555.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111203852259.png" alt="Alt Text" /></p> <h2 id="34-模型类序列化器modelserializer">3.4 模型类序列化器ModelSerializer</h2> <p><img src="https://blog.slienceme.cn/images/posts/20210111214117444.png" alt="Alt Text" /></p> <blockquote> <p>如果我们想要使用序列化器对应的是Django的模型类，DRF为我们提供了ModelSerializer模型类序列化器来帮助我们快速创建一个Serializer类。</p> </blockquote> <blockquote> <p>ModelSerializer与常规的Serializer相同，但提供了：</p> </blockquote> <ul> <li>基于模型类自动生成一系列字段</li> <li>包含默认的create()和update()的实现</li> </ul> <h3 id="1-定义">1. 定义</h3> <blockquote> <p>比如我们创建一个BookInfoSerializer</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
</code></pre></div></div> <ul> <li>model 指明参照哪个模型类</li> <li>fields 指明为模型类的哪些字段生成</li> </ul> <blockquote> <p>我们可以在python manage.py shell中查看自动生成的BookInfoSerializer的具体实现</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">booktest.serializers</span> <span class="kn">import</span> <span class="n">BookInfoSerializer</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span>
<span class="n">BookInfoSerializer</span><span class="p">():</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'ID'</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">btitle</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'名称'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bpub_date</span> <span class="o">=</span> <span class="n">DateField</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'发布日期'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">2147483647</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=-</span><span class="mi">2147483648</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bcomment</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'评论量'</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">2147483647</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=-</span><span class="mi">2147483648</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ImageField</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'图片'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <h3 id="2-指定字段">2. 指定字段</h3> <blockquote> <p>1) 使用fields来明确字段，__all__表名包含所有字段，也可以写明具体哪些字段，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'btitle'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>2) 使用exclude可以明确排除掉哪些字段</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s">'image'</span><span class="p">,)</span>
</code></pre></div></div> <blockquote> <p>3) 显示指明字段，如：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HeroInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">hbook</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">HeroInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'hname'</span><span class="p">,</span> <span class="s">'hgender'</span><span class="p">,</span> <span class="s">'hcomment'</span><span class="p">,</span> <span class="s">'hbook'</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>4) 指明只读字段</p> </blockquote> <blockquote> <p>可以通过read_only_fields指明只读字段，即仅用于序列化输出的字段</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'btitle'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="err">，</span> <span class="s">'bread'</span><span class="p">,</span> <span class="s">'bcomment'</span><span class="p">)</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'bread'</span><span class="p">,</span> <span class="s">'bcomment'</span><span class="p">)</span>
</code></pre></div></div> <h3 id="3-添加额外参数">3. 添加额外参数</h3> <blockquote> <p>我们可以使用extra_kwargs参数为ModelSerializer添加或修改原有的选项参数</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""图书数据序列化器"""</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'btitle'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">,</span> <span class="s">'bread'</span><span class="p">,</span> <span class="s">'bcomment'</span><span class="p">)</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="p">{</span><span class="s">'min_value'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'required'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
            <span class="s">'bcomment'</span><span class="p">:</span> <span class="p">{</span><span class="s">'min_value'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'required'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
        <span class="p">}</span>

<span class="c1"># BookInfoSerializer():
#    id = IntegerField(label='ID', read_only=True)
#    btitle = CharField(label='名称', max_length=20)
#    bpub_date = DateField(allow_null=True, label='发布日期', required=False)
#    bread = IntegerField(label='阅读量', max_value=2147483647, min_value=0, required=True)
#    bcomment = IntegerField(label='评论量', max_value=2147483647, min_value=0, required=True)
</span></code></pre></div></div> <p><img src="https://blog.slienceme.cn/images/posts/20210111212152667.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212300139.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212321953.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212413408.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212434345.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212619409.png" alt="Alt Text" /> <img src="https://blog.slienceme.cn/images/posts/20210111212756291.png" alt="Alt Text" /></p> <p><img src="https://blog.slienceme.cn/images/posts/20210111212707999.png" alt="Alt Text" /></p> <h1 id="4-视图">4. 视图</h1> <h2 id="41-request-与-response">4.1 Request 与 Response</h2> <h3 id="1-request">1. Request</h3> <blockquote> <p>REST framework 传入视图的request对象不再是Django默认的HttpRequest对象，而是REST framework提供的扩展了HttpRequest类的Request类的对象。</p> </blockquote> <blockquote> <p>REST framework提供了Parser解析器，在接收到请求后会自动根据Content-Type指明的请求数据类型（如JSON、表单等）将请求数据进行parse解析，解析为类字典对象保存到Request对象中。</p> </blockquote> <blockquote> <p>Request对象的数据是自动根据前端发送数据的格式进行解析之后的结果。</p> </blockquote> <blockquote> <p>无论前端发送的哪种格式的数据，我们都可以以统一的方式读取数据。</p> </blockquote> <h4 id="常用属性">常用属性</h4> <h5 id="1data">1）.data</h5> <blockquote> <p>request.data 返回解析之后的请求体数据。类似于Django中标准的request.POST和 request.FILES属性，但提供如下特性：</p> <ul> <li>包含了解析之后的文件和非文件数据</li> <li>包含了对POST、PUT、PATCH请求方式解析后的数据</li> <li>利用了REST framework的parsers解析器，不仅支持表单类型数据，也支持JSON数据</li> </ul> </blockquote> <h5 id="2query_params">2）.query_params</h5> <blockquote> <p>request.query_params与Django标准的request.GET相同，只是更换了更正确的名称而已。</p> </blockquote> <h3 id="2-response">2. Response</h3> <blockquote> <p>rest_framework.response.Response</p> </blockquote> <blockquote> <p>REST framework提供了一个响应类Response，使用该类构造响应对象时，响应的具体数据内容会被转换（render渲染）成符合前端需求的类型。</p> </blockquote> <blockquote> <p>REST framework提供了Renderer渲染器，用来根据请求头中的Accept（接收数据类型声明）来自动转换响应数据到对应格式。如果前端请求中未进行Accept声明，则会采用默认方式处理响应数据，我们可以通过配置来修改默认响应格式。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_RENDERER_CLASSES'</span><span class="p">:</span> <span class="p">(</span>  <span class="c1"># 默认响应渲染类
</span>        <span class="s">'rest_framework.renderers.JSONRenderer'</span><span class="p">,</span>  <span class="c1"># json渲染器
</span>        <span class="s">'rest_framework.renderers.BrowsableAPIRenderer'</span><span class="p">,</span>  <span class="c1"># 浏览API渲染器
</span>    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <h4 id="构造方式">构造方式</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>data数据不要是render处理之后的数据，只需传递python的内建类型数据即可，REST framework会使用renderer渲染器处理data。</p> </blockquote> <blockquote> <p>data不能是复杂结构的数据，如Django的模型类对象，对于这样的数据我们可以使用Serializer序列化器序列化处理后（转为了Python字典类型）再传递给data参数。 参数说明：</p> <ul> <li>data: 为响应准备的序列化处理后的数据；</li> <li>status: 状态码，默认200；</li> <li>template_name: 模板名称，如果使用HTMLRenderer 时需指明；</li> <li>headers: 用于存放响应头信息的字典；</li> <li>content_type: 响应数据的Content-Type，通常此参数无需传递，REST framework会根据前端所需类型数据来设置该参数。</li> </ul> </blockquote> <h4 id="常用属性-1">常用属性：</h4> <p><strong>1）.data</strong></p> <blockquote> <p>传给response对象的序列化后，但尚未render处理的数据</p> </blockquote> <p><strong>2）.status_code</strong></p> <blockquote> <p>状态码的数字</p> </blockquote> <p><strong>3）.content</strong></p> <blockquote> <p>经过render处理后的响应数据</p> </blockquote> <h3 id="3-状态码">3. 状态码</h3> <blockquote> <p>为了方便设置状态码，REST framewrok在rest_framework.status模块中提供了常用状态码常量。</p> </blockquote> <p><strong>1）信息告知 - 1xx</strong></p> <blockquote> <p>HTTP_100_CONTINUE HTTP_101_SWITCHING_PROTOCOLS</p> </blockquote> <p><strong>2）成功 - 2xx</strong></p> <blockquote> <p>HTTP_200_OK HTTP_201_CREATED HTTP_202_ACCEPTED HTTP_203_NON_AUTHORITATIVE_INFORMATION HTTP_204_NO_CONTENT HTTP_205_RESET_CONTENT HTTP_206_PARTIAL_CONTENT HTTP_207_MULTI_STATUS</p> </blockquote> <p><strong>3）重定向 - 3xx</strong></p> <blockquote> <p>HTTP_300_MULTIPLE_CHOICES HTTP_301_MOVED_PERMANENTLY HTTP_302_FOUND HTTP_303_SEE_OTHER HTTP_304_NOT_MODIFIED HTTP_305_USE_PROXY HTTP_306_RESERVED HTTP_307_TEMPORARY_REDIRECT</p> </blockquote> <p><strong>4）客户端错误 - 4xx</strong></p> <blockquote> <p>HTTP_400_BAD_REQUEST HTTP_401_UNAUTHORIZED HTTP_402_PAYMENT_REQUIRED HTTP_403_FORBIDDEN HTTP_404_NOT_FOUND HTTP_405_METHOD_NOT_ALLOWED HTTP_406_NOT_ACCEPTABLE HTTP_407_PROXY_AUTHENTICATION_REQUIRED HTTP_408_REQUEST_TIMEOUT HTTP_409_CONFLICT HTTP_410_GONE HTTP_411_LENGTH_REQUIRED HTTP_412_PRECONDITION_FAILED HTTP_413_REQUEST_ENTITY_TOO_LARGE HTTP_414_REQUEST_URI_TOO_LONG HTTP_415_UNSUPPORTED_MEDIA_TYPE HTTP_416_REQUESTED_RANGE_NOT_SATISFIABLE HTTP_417_EXPECTATION_FAILED HTTP_422_UNPROCESSABLE_ENTITY HTTP_423_LOCKED HTTP_424_FAILED_DEPENDENCY HTTP_428_PRECONDITION_REQUIRED HTTP_429_TOO_MANY_REQUESTS HTTP_431_REQUEST_HEADER_FIELDS_TOO_LARGE HTTP_451_UNAVAILABLE_FOR_LEGAL_REASONS</p> </blockquote> <p><strong>5）服务器错误 - 5xx</strong></p> <blockquote> <p>HTTP_500_INTERNAL_SERVER_ERROR HTTP_501_NOT_IMPLEMENTED HTTP_502_BAD_GATEWAY HTTP_503_SERVICE_UNAVAILABLE HTTP_504_GATEWAY_TIMEOUT HTTP_505_HTTP_VERSION_NOT_SUPPORTED HTTP_507_INSUFFICIENT_STORAGE HTTP_511_NETWORK_AUTHENTICATION_REQUIRED</p> </blockquote> <h2 id="42-视图概览">4.2 视图概览</h2> <blockquote> <p>REST framework 提供了众多的通用视图基类与扩展类，以简化视图的编写。</p> </blockquote> <p>视图的继承关系：</p> <p><img src="https://blog.slienceme.cn/images/posts/20210111205635471.png" alt="Alt Text" /></p> <p>视图的方法与属性： <img src="https://blog.slienceme.cn/images/posts/20210111205648529.png" alt="Alt Text" /></p> <h2 id="43-视图说明">4.3 视图说明</h2> <h3 id="1-两个基类">1. 两个基类</h3> <h4 id="1apiview">1）APIView</h4> <blockquote> <p>rest_framework.views.APIView</p> </blockquote> <blockquote> <p>APIView是REST framework提供的所有视图的基类，继承自Django的View父类。</p> </blockquote> <blockquote> <p>APIView与View的不同之处在于：</p> <ul> <li>传入到视图方法中的是REST framework的Request对象，而不是Django的HttpRequeset对象；</li> <li>视图方法可以返回REST framework的Response对象，视图会为响应数据设置（render）符合前端要求的格式；</li> <li>任何APIException异常都会被捕获到，并且处理成合适的响应信息；</li> <li>在进行dispatch()分发前，会对请求进行身份认证、权限检查、流量控制。</li> </ul> </blockquote> <p><strong>支持定义的属性：</strong></p> <blockquote> <ul> <li>authentication_classes 列表或元组，身份认证类</li> <li>permissoin_classes 列表或元组，权限检查类</li> <li>throttle_classes 列表或元组，流量控制类</li> </ul> <p>在APIView中仍以常规的类视图定义方法来实现get() 、post() 或者其他请求方式的方法。</p> </blockquote> <p><strong>加粗样式</strong>举例：</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="c1"># url(r'^books/$', views.BookListView.as_view()),
</span><span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">books</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <h4 id="2genericapiview">2）GenericAPIView</h4> <blockquote> <p>rest_framework.generics.GenericAPIView</p> </blockquote> <blockquote> <p>继承自APIVIew，主要增加了操作序列化器和数据库查询的方法，作用是为下面Mixin扩展类的执行提供方法支持。通常在使用时，可搭配一个或多个Mixin扩展类。</p> </blockquote> <blockquote> <p><strong>提供的关于序列化器使用的属性与方法</strong></p> <ul> <li> <p>属性：</p> <ul> <li>serializer_class 指明视图使用的序列化器</li> </ul> </li> <li> <p>方法：</p> <ul> <li>get_serializer_class(self) 返回序列化器类，默认返回serializer_class，可以重写，例如： <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_staff</span><span class="p">:</span>
  <span class="k">return</span> <span class="n">FullAccountSerializer</span>
  <span class="k">return</span> <span class="n">BasicAccountSerializer</span>
</code></pre></div> </div> </li> </ul> </li> </ul> </blockquote> <blockquote> <ul> <li> <p>get_serializer(self, args, *kwargs) 返回序列化器对象，主要用来提供给Mixin扩展类使用，如果我们在视图中想要获取序列化器对象，也可以直接调用此方法。</p> </li> <li> <p>注意，该方法在提供序列化器对象的时候，会向序列化器对象的context属性补充三个数据：request、format、view，这三个数据对象可以在定义序列化器时使用。</p> <ul> <li> <p>request 当前视图的请求对象</p> </li> <li> <p>view 当前请求的类视图对象</p> </li> <li> <p>format 当前请求期望返回的数据格式</p> </li> </ul> </li> </ul> </blockquote> <blockquote> <p><strong>提供的关于数据库查询的属性与方法</strong></p> <ul> <li> <p>属性：</p> <ul> <li>queryset 指明使用的数据查询集</li> </ul> </li> <li> <p>方法：</p> <ul> <li>get_queryset(self)</li> <li>返回视图使用的查询集，主要用来提供给Mixin扩展类使用，是列表视图与详情视图获取数据的基础，默认返回queryset属性，可以重写，例如：</li> </ul> </li> </ul> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">user</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
</code></pre></div></div> <blockquote> <ul> <li>get_object(self) <ul> <li> <p>返回详情视图所需的模型类数据对象，主要用来提供给Mixin扩展类使用。 在试图中可以调用该方法获取详情信息的模型类对象。</p> </li> <li> <p>若详情访问的模型类对象不存在，会返回404。</p> </li> <li> <p>该方法会默认使用APIView提供的check_object_permissions方法检查当前对象是否有权限被访问。</p> </li> </ul> </li> </ul> </blockquote> <blockquote> <p>举例：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># url(r'^books/(?P&lt;pk&gt;\d+)/$', views.BookDetailView.as_view()),
</span><span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_object</span><span class="p">()</span> <span class="c1"># get_object()方法根据pk参数查找queryset中的数据对象
</span>        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p><strong>其他可以设置的属性</strong></p> <ul> <li>pagination_class 指明分页控制类</li> <li>filter_backends 指明过滤控制后端</li> </ul> </blockquote> <h3 id="2-五个扩展类">2. 五个扩展类</h3> <blockquote> <p><strong>作用：</strong> 提供了几种后端视图（对数据资源进行曾删改查）处理流程的实现，如果需要编写的视图属于这五种，则视图可以通过继承相应的扩展类来复用代码，减少自己编写的代码量。</p> </blockquote> <blockquote> <p>这五个扩展类需要搭配GenericAPIView父类，因为五个扩展类的实现需要调用GenericAPIView提供的序列化器与数据库查询的方法。</p> </blockquote> <h5 id="1listmodelmixin">1）ListModelMixin</h5> <blockquote> <p>列表视图扩展类，提供list(request, *args, **kwargs)方法快速实现列表视图，返回200状态码。</p> </blockquote> <blockquote> <p>该Mixin的list方法会对数据进行过滤和分页。</p> </blockquote> <p><strong>源代码：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ListModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    List a queryset.
    """</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># 过滤
</span>        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_queryset</span><span class="p">())</span>
        <span class="c1"># 分页
</span>        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># 序列化
</span>        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <p><strong>举例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.mixins</span> <span class="kn">import</span> <span class="n">ListModelMixin</span>

<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div></div> <h5 id="2createmodelmixin">2）CreateModelMixin</h5> <blockquote> <p>创建视图扩展类，提供create(request, *args, **kwargs)方法快速实现创建资源的视图，成功返回201状态码。</p> </blockquote> <blockquote> <p>如果序列化器对前端发送的数据验证失败，返回400错误。</p> </blockquote> <p><strong>源代码：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    Create a model instance.
    """</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># 获取序列化器
</span>        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># 验证
</span>        <span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># 保存
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">perform_create</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_success_headers</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_success_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">'Location'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">api_settings</span><span class="p">.</span><span class="n">URL_FIELD_NAME</span><span class="p">])}</span>
        <span class="k">except</span> <span class="p">(</span><span class="nb">TypeError</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>
</code></pre></div></div> <h5 id="3-retrievemodelmixin">3） RetrieveModelMixin</h5> <blockquote> <p>详情视图扩展类，提供retrieve(request, *args, **kwargs)方法，可以快速实现返回一个存在的数据对象。</p> </blockquote> <blockquote> <p>如果存在，返回200， 否则返回404。</p> </blockquote> <p><strong>源代码：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RetrieveModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    Retrieve a model instance.
    """</span>
    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># 获取对象，会检查对象的权限
</span>        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># 序列化
</span>        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <p><strong>举例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div></div> <h5 id="4updatemodelmixin">4）UpdateModelMixin</h5> <blockquote> <p>更新视图扩展类，提供update(request, *args, **kwargs)方法，可以快速实现更新一个存在的数据对象。</p> </blockquote> <blockquote> <p>同时也提供partial_update(request, *args, **kwargs)方法，可以实现局部更新。</p> </blockquote> <blockquote> <p>成功返回200，序列化器校验数据失败时，返回400错误。</p> </blockquote> <p><strong>源代码：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UpdateModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    Update a model instance.
    """</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'partial'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="n">partial</span><span class="p">)</span>
        <span class="n">serializer</span><span class="p">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">perform_update</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">'_prefetched_objects_cache'</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="c1"># If 'prefetch_related' has been applied to a queryset, we need to
</span>            <span class="c1"># forcibly invalidate the prefetch cache on the instance.
</span>            <span class="n">instance</span><span class="p">.</span><span class="n">_prefetched_objects_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">partial_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">'partial'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div> <h5 id="5destroymodelmixin">5）DestroyModelMixin</h5> <blockquote> <p>删除视图扩展类，提供destroy(request, *args, **kwargs)方法，可以快速实现删除一个存在的数据对象。</p> </blockquote> <blockquote> <p>成功返回204，不存在返回404。</p> </blockquote> <p><strong>源代码：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DestroyModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    Destroy a model instance.
    """</span>
    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">perform_destroy</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div></div> <h4 id="3-几个可用子类视图">3. 几个可用子类视图</h4> <h5 id="1-createapiview">1） CreateAPIView</h5> <blockquote> <p>提供 post 方法</p> <p>继承自： GenericAPIView、CreateModelMixin</p> </blockquote> <h5 id="2listapiview">2）ListAPIView</h5> <blockquote> <p>提供 get 方法</p> <p>继承自：GenericAPIView、ListModelMixin</p> </blockquote> <h5 id="3retrieveapiview">3）RetrieveAPIView</h5> <blockquote> <p>提供 get 方法</p> <p>继承自: GenericAPIView、RetrieveModelMixin</p> </blockquote> <h5 id="4destoryapiview">4）DestoryAPIView</h5> <blockquote> <p>提供 delete 方法</p> <p>继承自：GenericAPIView、DestoryModelMixin</p> </blockquote> <h5 id="5updateapiview">5）UpdateAPIView</h5> <blockquote> <p>提供 put 和 patch 方法</p> <p>继承自：GenericAPIView、UpdateModelMixin</p> </blockquote> <h5 id="6retrieveupdateapiview">6）RetrieveUpdateAPIView</h5> <blockquote> <p>提供 get、put、patch方法</p> <p>继承自： GenericAPIView、RetrieveModelMixin、UpdateModelMixin</p> </blockquote> <h5 id="7retrieveupdatedestoryapiview">7）RetrieveUpdateDestoryAPIView</h5> <blockquote> <p>提供 get、put、patch、delete方法</p> <p>继承自：GenericAPIView、RetrieveModelMixin、UpdateModelMixin、DestoryModelMixin</p> </blockquote> <h2 id="44-视图集viewset">4.4 视图集ViewSet</h2> <blockquote> <p>使用视图集ViewSet，可以将一系列逻辑相关的动作放到一个类中：</p> <ul> <li>list() 提供一组数据</li> <li>retrieve() 提供单个数据</li> <li>create() 创建数据</li> <li>update() 保存数据</li> <li>destory() 删除数据</li> </ul> </blockquote> <blockquote> <p>ViewSet视图集类不再实现get()、post()等方法，而是实现动作 action 如 list() 、create() 等。</p> </blockquote> <blockquote> <p>视图集只在使用as_view()方法的时候，才会将action动作与具体请求方式对应上。如：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="p">.</span><span class="n">ViewSet</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">books</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">books</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>在设置路由时，我们可以如下操作</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/$'</span><span class="p">,</span> <span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span><span class="s">'list'</span><span class="p">}),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span> <span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'retrieve'</span><span class="p">})</span>
<span class="p">]</span>
</code></pre></div></div> <h3 id="1-常用视图集父类">1. 常用视图集父类</h3> <h4 id="1-viewset">1） ViewSet</h4> <blockquote> <p>继承自APIView与ViewSetMixin，作用也与APIView基本类似，提供了身份认证、权限校验、流量管理等。</p> </blockquote> <blockquote> <p>ViewSet主要通过继承ViewSetMixin来实现在调用as_view()时传入字典（如{‘get’:’list’}）的映射处理工作。</p> </blockquote> <blockquote> <p>在ViewSet中，没有提供任何动作action方法，需要我们自己实现action方法。</p> <h4 id="2genericviewset">2）GenericViewSet</h4> <p>使用ViewSet通常并不方便，因为list、retrieve、create、update、destory等方法都需要自己编写，而这些方法与前面讲过的Mixin扩展类提供的方法同名，所以我们可以通过继承Mixin扩展类来复用这些方法而无需自己编写。但是Mixin扩展类依赖与GenericAPIView，所以还需要继承GenericAPIView。</p> </blockquote> <blockquote> <p>GenericViewSet就帮助我们完成了这样的继承工作，继承自GenericAPIView与ViewSetMixin，在实现了调用as_view()时传入字典（如{‘get’:’list’}）的映射处理工作的同时，还提供了GenericAPIView提供的基础方法，可以直接搭配Mixin扩展类使用。</p> </blockquote> <p><strong>举例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">GenericViewSet</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>

<span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="p">.</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="p">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
</code></pre></div></div> <p><strong>url的定义</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">})),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'retrieve'</span><span class="p">})),</span>
<span class="p">]</span>
</code></pre></div></div> <h4 id="3modelviewset">3）ModelViewSet</h4> <blockquote> <p>继承自GenericViewSet，同时包括了ListModelMixin、RetrieveModelMixin、CreateModelMixin、UpdateModelMixin、DestoryModelMixin。</p> </blockquote> <h4 id="4readonlymodelviewset">4）ReadOnlyModelViewSet</h4> <blockquote> <p>继承自GenericViewSet，同时包括了ListModelMixin、RetrieveModelMixin。</p> </blockquote> <h3 id="2-视图集中定义附加action动作">2. 视图集中定义附加action动作</h3> <blockquote> <p>在视图集中，除了上述默认的方法动作外，还可以添加自定义动作。</p> </blockquote> <p><strong>举例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">GenericViewSet</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>

<span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="p">.</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="p">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>

    <span class="k">def</span> <span class="nf">latest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        返回最新的图书信息
        """</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">latest</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""
        修改图书的阅读量数据
        """</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">book</span><span class="p">.</span><span class="n">bread</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'bread'</span><span class="p">)</span>
        <span class="n">book</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <p><strong>url的定义</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">})),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/latest/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'latest'</span><span class="p">})),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'get'</span><span class="p">:</span> <span class="s">'retrieve'</span><span class="p">})),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^books/(?P&lt;pk&gt;\d+)/read/$'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">BookInfoViewSet</span><span class="p">.</span><span class="n">as_view</span><span class="p">({</span><span class="s">'put'</span><span class="p">:</span> <span class="s">'read'</span><span class="p">})),</span>
<span class="p">]</span>
</code></pre></div></div> <h3 id="3-action属性">3. action属性</h3> <blockquote> <p>在视图集中，我们可以通过action对象属性来获取当前请求视图集时的action动作是哪个。</p> </blockquote> <p><strong>例如：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">action</span> <span class="o">==</span> <span class="s">'create'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderCommitSerializer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrderDataSerializer</span>
</code></pre></div></div> <h3 id="4-视图集的继承关系">4. 视图集的继承关系</h3> <p><img src="https://blog.slienceme.cn/images/posts/20210112183339672.png" alt="Alt Text" /></p> <h2 id="45-路由routers">4.5 路由Routers</h2> <blockquote> <p>对于视图集ViewSet，我们除了可以自己手动指明请求方式与动作action之间的对应关系外，还可以使用Routers来帮助我们快速实现路由信息。</p> </blockquote> <blockquote> <p>REST framework提供了两个router</p> <ul> <li>SimpleRouter</li> <li>DefaultRouter</li> </ul> </blockquote> <h3 id="1-使用方法">1. 使用方法</h3> <blockquote> <p>1） 创建router对象，并注册视图集，例如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="p">.</span><span class="n">SimpleRouter</span><span class="p">()</span>
<span class="n">router</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s">'books'</span><span class="p">,</span> <span class="n">BookInfoViewSet</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="s">'book'</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>register(prefix, viewset, base_name)</p> <ul> <li>prefix 该视图集的路由前缀</li> <li>viewset 视图集</li> <li>base_name 路由名称的前缀</li> </ul> </blockquote> <blockquote> <p>如上述代码会形成的路由如下：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">^</span><span class="n">books</span><span class="o">/</span><span class="err">$</span>    <span class="n">name</span><span class="p">:</span> <span class="n">book</span><span class="o">-</span><span class="nb">list</span>
<span class="o">^</span><span class="n">books</span><span class="o">/</span><span class="p">{</span><span class="n">pk</span><span class="p">}</span><span class="o">/</span><span class="err">$</span>   <span class="n">name</span><span class="p">:</span> <span class="n">book</span><span class="o">-</span><span class="n">detail</span>
</code></pre></div></div> <blockquote> <p>2）添加路由数据</p> </blockquote> <blockquote> <p>可以有两种方式：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
<span class="p">]</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">router</span><span class="p">.</span><span class="n">urls</span>
</code></pre></div></div> <p><strong>或</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="p">.</span><span class="n">urls</span><span class="p">))</span>
<span class="p">]</span>
</code></pre></div></div> <h3 id="2-视图集中附加action的声明">2. 视图集中附加action的声明</h3> <blockquote> <p>在视图集中，如果想要让Router自动帮助我们为自定义的动作生成路由信息，需要使用rest_framework.decorators.action装饰器。</p> </blockquote> <blockquote> <p>以action装饰器装饰的方法名会作为action动作名，与list、retrieve等同。</p> </blockquote> <blockquote> <p>action装饰器可以接收两个参数：</p> <ul> <li>methods: 声明该action对应的请求方式，列表传递</li> <li>detail: 声明该action的路径是否与单一资源对应，及是否是xxx/<pk>/action方法名/ </pk> <ul> <li>True 表示路径格式是xxx/<pk>/action方法名/</pk></li> <li>False 表示路径格式是xxx/action方法名/</li> </ul> </li> </ul> </blockquote> <p><strong>举例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">GenericViewSet</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>

<span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="p">.</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="p">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>

    <span class="c1"># detail为False 表示路径名格式应该为 books/latest/
</span>    <span class="o">@</span><span class="n">action</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'get'</span><span class="p">],</span> <span class="n">detail</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">latest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s">"""
        返回最新的图书信息
        """</span>
        <span class="p">...</span>

    <span class="c1"># detail为True，表示路径名格式应该为 books/{pk}/read/
</span>    <span class="o">@</span><span class="n">action</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'put'</span><span class="p">],</span> <span class="n">detail</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="s">"""
        修改图书的阅读量数据
        """</span>
        <span class="p">...</span>
</code></pre></div></div> <blockquote> <p>由路由器自动为此视图集自定义action方法形成的路由会是如下内容：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">^</span><span class="n">books</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="err">$</span>    <span class="n">name</span><span class="p">:</span> <span class="n">book</span><span class="o">-</span><span class="n">latest</span>
<span class="o">^</span><span class="n">books</span><span class="o">/</span><span class="p">{</span><span class="n">pk</span><span class="p">}</span><span class="o">/</span><span class="n">read</span><span class="o">/</span><span class="err">$</span>  <span class="n">name</span><span class="p">:</span> <span class="n">book</span><span class="o">-</span><span class="n">read</span>
</code></pre></div></div> <h3 id="3-路由router形成url的方式">3. 路由router形成URL的方式</h3> <h4 id="1-simplerouter">1） SimpleRouter</h4> <p><img src="https://blog.slienceme.cn/images/posts/2021011218383936.png" alt="Alt Text" /></p> <h4 id="2defaultrouter">2）DefaultRouter</h4> <p><img src="https://blog.slienceme.cn/images/posts/202101121838562.png" alt="Alt Text" /></p> <blockquote> <p>DefaultRouter与SimpleRouter的区别是，DefaultRouter会多附带一个默认的API根视图，返回一个包含所有列表视图的超链接响应数据。</p> </blockquote> <h1 id="5-其他功能">5. 其他功能</h1> <h2 id="51-认证">5.1 认证</h2> <h3 id="认证authentication">认证Authentication</h3> <blockquote> <p>可以在配置文件中配置全局默认的认证方案</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.authentication.BasicAuthentication'</span><span class="p">,</span>   <span class="c1"># 基本认证
</span>        <span class="s">'rest_framework.authentication.SessionAuthentication'</span><span class="p">,</span>  <span class="c1"># session认证
</span>    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>也可以在每个视图中通过设置authentication_classess属性来设置</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div> <blockquote> <p>认证失败会有两种可能的返回值：</p> <ul> <li>401 Unauthorized 未认证</li> <li>403 Permission Denied 权限被禁止</li> </ul> </blockquote> <h2 id="52-权限">5.2 权限</h2> <h3 id="权限permissions">权限Permissions</h3> <blockquote> <p>权限控制可以限制用户对于视图的访问和对于具体数据对象的访问。</p> <ul> <li>在执行视图的dispatch()方法前，会先进行视图访问权限的判断</li> <li>在通过get_object()获取具体对象时，会进行对象访问权限的判断 <h4 id="使用">使用</h4> <p>可以在配置文件中设置默认的权限管理类，如</p> </li> </ul> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_PERMISSION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.permissions.IsAuthenticated'</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>如果未指明，则采用如下默认配置</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'DEFAULT_PERMISSION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
   <span class="s">'rest_framework.permissions.AllowAny'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div> <blockquote> <p>也可以在具体的视图中通过permission_classes属性来设置，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span>
    <span class="p">...</span>
</code></pre></div></div> <blockquote> <h4 id="提供的权限">提供的权限</h4> <ul> <li>AllowAny 允许所有用户</li> <li>IsAuthenticated 仅通过认证的用户</li> <li>IsAdminUser 仅管理员用户</li> <li>IsAuthenticatedOrReadOnly 认证的用户可以完全操作，否则只能get读取</li> </ul> </blockquote> <p><strong>举例</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.generics</span> <span class="kn">import</span> <span class="n">RetrieveAPIView</span>

<span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
</code></pre></div></div> <h4 id="自定义权限">自定义权限</h4> <blockquote> <p>如需自定义权限，需继承rest_framework.permissions.BasePermission父类，并实现以下两个任何一个方法或全部</p> <ul> <li> <p>.has_permission(self, request, view) 是否可以访问视图， view表示当前视图对象</p> </li> <li> <p>.has_object_permission(self, request, view, obj) 是否可以访问数据对象， view表示当前视图， obj为数据对象</p> </li> </ul> </blockquote> <p><strong>例如：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="s">"""控制对obj对象的访问权限，此案例决绝所有对对象的访问"""</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">,</span> <span class="n">MyPermission</span><span class="p">]</span>
</code></pre></div></div> <h2 id="53-限流">5.3 限流</h2> <h3 id="限流throttling">限流Throttling</h3> <blockquote> <p>可以对接口访问的频次进行限制，以减轻服务器压力。</p> </blockquote> <h4 id="使用-1">使用</h4> <blockquote> <p>可以在配置文件中，使用DEFAULT_THROTTLE_CLASSES 和 DEFAULT_THROTTLE_RATES进行全局配置，</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_THROTTLE_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.throttling.AnonRateThrottle'</span><span class="p">,</span>
        <span class="s">'rest_framework.throttling.UserRateThrottle'</span>
    <span class="p">),</span>
    <span class="s">'DEFAULT_THROTTLE_RATES'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'anon'</span><span class="p">:</span> <span class="s">'100/day'</span><span class="p">,</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="s">'1000/day'</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>DEFAULT_THROTTLE_RATES 可以使用 second, minute, hour 或day来指明周期。</p> </blockquote> <blockquote> <p>也可以在具体视图中通过throttle_classess属性来配置，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">UserRateThrottle</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">UserRateThrottle</span><span class="p">,)</span>
    <span class="p">...</span>
</code></pre></div></div> <h4 id="可选限流类">可选限流类</h4> <blockquote> <p>1） AnonRateThrottle</p> <p>限制所有匿名未认证用户，使用IP区分用户。</p> <p>使用DEFAULT_THROTTLE_RATES[‘anon’] 来设置频次</p> <p>2）UserRateThrottle</p> <p>限制认证用户，使用User id 来区分。</p> <p>使用DEFAULT_THROTTLE_RATES[‘user’] 来设置频次</p> <p>3）ScopedRateThrottle</p> <p>限制用户对于每个视图的访问频次，使用ip或user id。</p> </blockquote> <p><strong>例如：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ContactListView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_scope</span> <span class="o">=</span> <span class="s">'contacts'</span>
    <span class="p">...</span>

<span class="k">class</span> <span class="nc">ContactDetailView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_scope</span> <span class="o">=</span> <span class="s">'contacts'</span>
    <span class="p">...</span>

<span class="k">class</span> <span class="nc">UploadView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">throttle_scope</span> <span class="o">=</span> <span class="s">'uploads'</span>
    <span class="p">...</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_THROTTLE_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.throttling.ScopedRateThrottle'</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s">'DEFAULT_THROTTLE_RATES'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'contacts'</span><span class="p">:</span> <span class="s">'1000/day'</span><span class="p">,</span>
        <span class="s">'uploads'</span><span class="p">:</span> <span class="s">'20/day'</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>实例</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.generics</span> <span class="kn">import</span> <span class="n">RetrieveAPIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">UserRateThrottle</span>

<span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">UserRateThrottle</span><span class="p">,)</span>
</code></pre></div></div> <h2 id="54-过滤">5.4 过滤</h2> <h3 id="过滤filtering">过滤Filtering</h3> <blockquote> <p>对于列表数据可能需要根据字段进行过滤，我们可以通过添加django-fitlter扩展来增强支持。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="nb">filter</span>
</code></pre></div></div> <blockquote> <p>在配置文件中增加过滤后端的设置：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="s">'django_filters'</span><span class="p">,</span>  <span class="c1"># 需要注册应用，
</span><span class="p">]</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_FILTER_BACKENDS'</span><span class="p">:</span> <span class="p">(</span><span class="s">'django_filters.rest_framework.DjangoFilterBackend'</span><span class="p">,)</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>在视图中添加filter_fields属性，指定可以过滤的字段</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'btitle'</span><span class="p">,</span> <span class="s">'bread'</span><span class="p">)</span>

<span class="c1"># 127.0.0.1:8000/books/?btitle=西游记
</span></code></pre></div></div> <h2 id="55-排序">5.5 排序</h2> <h3 id="排序">排序</h3> <blockquote> <p>对于列表数据，REST framework提供了OrderingFilter过滤器来帮助我们快速指明数据按照指定字段进行排序。</p> <h4 id="使用方法">使用方法：</h4> <p>在类视图中设置filter_backends，使用rest_framework.filters.OrderingFilter过滤器，REST framework会在请求的查询字符串参数中检查是否包含了ordering参数，如果包含了ordering参数，则按照ordering参数指明的排序字段对数据集进行排序。</p> </blockquote> <blockquote> <p>前端可以传递的ordering参数的可选字段值需要在ordering_fields中指明。</p> </blockquote> <p><strong>示例：</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderingFilter</span><span class="p">]</span>
    <span class="n">ordering_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'bread'</span><span class="p">,</span> <span class="s">'bpub_date'</span><span class="p">)</span>

<span class="c1"># 127.0.0.1:8000/books/?ordering=-bread
</span></code></pre></div></div> <h2 id="56-分页">5.6 分页</h2> <h3 id="分页pagination">分页Pagination</h3> <blockquote> <p>REST framework提供了分页的支持。</p> </blockquote> <blockquote> <p>我们可以在配置文件中设置全局的分页方式，如：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_PAGINATION_CLASS'</span><span class="p">:</span>  <span class="s">'rest_framework.pagination.PageNumberPagination'</span><span class="p">,</span>
    <span class="s">'PAGE_SIZE'</span><span class="p">:</span> <span class="mi">100</span>  <span class="c1"># 每页数目
</span><span class="p">}</span>
</code></pre></div></div> <blockquote> <p>也可通过自定义Pagination类，来为视图添加不同分页行为。在视图中通过pagination_clas属性来指明。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LargeResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s">'page_size'</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">10000</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
</code></pre></div></div> <blockquote> <p>注意：如果在视图内关闭分页功能，只需在视图内设置</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pagination_class</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div> <h4 id="可选分页器">可选分页器</h4> <h5 id="1-pagenumberpagination">1） PageNumberPagination</h5> <blockquote> <p>前端访问网址形式： <code class="language-plaintext highlighter-rouge">GET http://api.example.org/books/?page=4</code></p> </blockquote> <blockquote> <p>可以在子类中定义的属性：</p> <ul> <li>page_size 每页数目</li> <li>page_query_param 前端发送的页数关键字名，默认为”page”</li> <li>page_size_query_param 前端发送的每页数目关键字名，默认为None</li> <li>max_page_size 前端最多能设置的每页数量</li> </ul> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>

<span class="k">class</span> <span class="nc">StandardPageNumberPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s">'page_size'</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="n">order_by</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">StandardPageNumberPagination</span>

<span class="c1"># 127.0.0.1/books/?page=1&amp;page_size=2
</span></code></pre></div></div> <h5 id="2limitoffsetpagination">2）LimitOffsetPagination</h5> <blockquote> <p>前端访问网址形式： <code class="language-plaintext highlighter-rouge">GET http://api.example.org/books/?limit=100&amp;offset=400</code></p> </blockquote> <blockquote> <p>可以在子类中定义的属性：</p> <ul> <li>default_limit 默认限制，默认值与PAGE_SIZE设置一直</li> <li>limit_query_param limit参数名，默认’limit’</li> <li>offset_query_param offset参数名，默认’offset’</li> <li>max_limit 最大limit限制，默认None</li> </ul> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">LimitOffsetPaginati</span><span class="err">`</span><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">exception_handler</span>

<span class="k">def</span> <span class="nf">custom_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># 先调用REST framework默认的异常处理方法获得标准错误响应对象
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># 在此处补充自定义的异常处理
</span>    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="s">'status_code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span>

    <span class="k">return</span> <span class="n">response</span><span class="err">`</span><span class="n">on</span>

<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="n">order_by</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LimitOffsetPagination</span>

<span class="c1"># 127.0.0.1:8000/books/?offset=3&amp;limit=2
</span></code></pre></div></div> <h2 id="57-异常处理">5.7 异常处理</h2> <h3 id="异常处理-exceptions">异常处理 Exceptions</h3> <blockquote> <p>REST framework提供了异常处理，我们可以自定义异常处理函数。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">exception_handler</span>

<span class="k">def</span> <span class="nf">custom_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># 先调用REST framework默认的异常处理方法获得标准错误响应对象
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># 在此处补充自定义的异常处理
</span>    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="s">'status_code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div> <blockquote> <p>在配置文件中声明自定义的异常处理</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'EXCEPTION_HANDLER'</span><span class="p">:</span> <span class="s">'my_project.my_app.utils.custom_exception_handler'</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>如果未声明，会采用默认的方式，如下</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'EXCEPTION_HANDLER'</span><span class="p">:</span> <span class="s">'rest_framework.views.exception_handler'</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>例如：</p> <p>补充上处理关于数据库的异常</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">exception_handler</span> <span class="k">as</span> <span class="n">drf_exception_handler</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">DatabaseError</span>

<span class="k">def</span> <span class="nf">exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">drf_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">'view'</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'[%s]: %s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s">'detail'</span><span class="p">:</span> <span class="s">'服务器内部错误'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">.</span><span class="n">HTTP_507_INSUFFICIENT_STORAGE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div> <blockquote> <p>REST framework提供了异常处理，我们可以自定义异常处理函数。</p> <h4 id="rest-framework定义的异常">REST framework定义的异常</h4> <ul> <li>APIException 所有异常的父类</li> <li>ParseError 解析错误</li> <li>AuthenticationFailed 认证失败</li> <li>NotAuthenticated 尚未认证</li> <li>PermissionDenied 权限决绝</li> <li>NotFound 未找到</li> <li>MethodNotAllowed 请求方式不支持</li> <li>NotAcceptable 要获取的数据格式不支持</li> <li>Throttled 超过限流次数</li> <li>ValidationError 校验失败 <h2 id="58-自动生成接口文档">5.8 自动生成接口文档</h2> <h3 id="自动生成接口文档">自动生成接口文档</h3> <p>REST framework可以自动帮助我们生成接口文档。</p> </li> </ul> </blockquote> <blockquote> <p>接口文档以网页的方式呈现。</p> </blockquote> <blockquote> <p>自动接口文档能生成的是继承自APIView及其子类的视图。</p> </blockquote> <h4 id="1-安装依赖">1. 安装依赖</h4> <blockquote> <p>REST framewrok生成接口文档需要coreapi库的支持。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip</span> <span class="n">install</span> <span class="n">coreapi</span>
</code></pre></div></div> <h4 id="2-设置接口文档访问路径">2. 设置接口文档访问路径</h4> <blockquote> <p>在总路由中添加接口文档路径。</p> </blockquote> <blockquote> <p>文档路由对应的视图配置为 rest_framework.documentation.include_docs_urls，</p> </blockquote> <blockquote> <p>参数title为接口文档网站的标题。</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.documentation</span> <span class="kn">import</span> <span class="n">include_docs_urls</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">'^docs/'</span><span class="p">,</span> <span class="n">include_docs_urls</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'My API title'</span><span class="p">))</span>
<span class="p">]</span>

<span class="c1"># settings.py
</span><span class="s">'DEFAULT_SCHEMA_CLASS'</span><span class="p">:</span> <span class="s">'rest_framework.schemas.coreapi.AutoSchema'</span><span class="p">,</span>
</code></pre></div></div> <h4 id="3-文档描述说明的定义位置">3. 文档描述说明的定义位置</h4> <blockquote> <p>1） 单一方法的视图，可直接使用类视图的文档字符串，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">generics</span><span class="p">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="s">"""
    返回所有图书信息.
    """</span>
</code></pre></div></div> <blockquote> <p>2）包含多个方法的视图，在类视图的文档字符串中，分开方法定义，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookListCreateView</span><span class="p">(</span><span class="n">generics</span><span class="p">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="s">"""
    get:
    返回所有图书信息.

    post:
    新建图书.
    """</span>
</code></pre></div></div> <blockquote> <p>3）对于视图集ViewSet，仍在类视图的文档字符串中封开定义，但是应使用action名称区分，如</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfoViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="p">.</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="p">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
    <span class="s">"""
    list:
    返回图书列表数据

    retrieve:
    返回图书详情数据

    latest:
    返回最新的图书数据

    read:
    修改图书的阅读量
    """</span>
</code></pre></div></div> <h4 id="4-访问接口文档网页">4. 访问接口文档网页</h4> <blockquote> <p>浏览器访问 127.0.0.1:8000/docs/，即可看到自动生成的接口文档。 <img src="https://blog.slienceme.cn/images/posts/20210112190338490.png" alt="Alt Text" /></p> </blockquote> <blockquote> <h4 id="两点说明-1">两点说明：</h4> <p>1） 视图集ViewSet中的retrieve名称，在接口文档网站中叫做read 2）参数的Description需要在模型类或序列化器类的字段中以help_text选项定义，如：</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="n">bread</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s">'阅读量'</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div> <p>或</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BookReadSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'bread'</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'bread'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'required'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">'help_text'</span><span class="p">:</span> <span class="s">'阅读量'</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div> <div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"> <h3>文档信息</h3> <ul> <li>本文作者：<a href="https://blog.slienceme.cn" target="_blank">slience_me</a></li> <li>本文链接：<a href="https://blog.slienceme.cn/2021/01/10/django_rest_framework%E5%AD%A6%E4%B9%A0/" target="_blank">https://blog.slienceme.cn/2021/01/10/django_rest_framework%E5%AD%A6%E4%B9%A0/</a></li> <li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li> </ul> </div> </article> <div class="share"> <div class="share-component" data-disabled='qq,facebook'></div> </div> <div class="comment"> <script src="https://giscus.app/client.js" data-repo="slience-me/blog-comments" data-repo-id="R_kgDOKr27jA" data-category="Announcements" data-category-id="DIC_kwDOKr27jM4CnWMe" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script> </div> </div> <div class="column one-fourth"> <h3>Search</h3> <div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"> </div> <ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul> <script src="https://blog.slienceme.cn/assets/js/simple-jekyll-search.min.js"></script> <script src=" https://cdn.jsdelivr.net/npm/@docsearch/js@3 "></script> <script type="text/javascript"> docsearch({ appId: "8W5T6R2WWG", apiKey: "e56e511c7c9f85e2c97e2817664aafb2", indexName: "doc", container: "#search_box", debug: false }); // SimpleJekyllSearch({ // searchInput: document.getElementById('search_box'), // resultsContainer: document.getElementById('search_results'), // // json: 'https://blog.slienceme.cn/assets/search_data.json?v=1740710261', // // searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', // noResultsText: 'No results found', // limit: 10, // fuzzy: false, // exclude: ['Welcome'] // }) </script> <h3 class="post-directory-title mobile-hidden">Table of Contents</h3> <div id="post-directory-module" class="mobile-hidden"> <section class="post-directory"> <dl></dl> </section> </div> <script src="https://blog.slienceme.cn/assets/js/jquery.toc.js"></script> </div> </div> </section> <footer class="container"> <div class="site-footer" role="contentinfo"> <div class="copyright left mobile-block"> <div style="display: flex;align-items: center;justify-content: center;"> <img src="/images/logo/logo.png" class="w-full" style="height: 10px;width: 10px;" alt="logo" />;"> <p> <a href="https://beian.mps.gov.cn/" rel="noreferrer" target="_blank">冀公网安备13102202000626</a> | <a href="https://beian.miit.gov.cn/" target="_blank" rel="noreferrer">津ICP备2024026565号-1</a> </p> </div> <p style="display: flex;align-items: center;justify-content: center;"> Copyright © 2019-present slience_me </p> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a> </div> <ul class="site-footer-links right mobile-hidden"> <li> <a href="javascript:window.scrollTo(0,0)" >TOP</a> </li> </ul> <br/> <script defer src="https://vercount.one/js"></script> <div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2024-12-01 </span> </div> </div> </footer> <div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a> </div> <script src="https://blog.slienceme.cn/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://blog.slienceme.cn/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script> </body> </html>
